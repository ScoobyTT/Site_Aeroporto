{% extends 'base.html' %}
{% block content %}

<!-- Navbar -->


<div class="container mt-4">
    <h1 class="text-center mb-4">üë• Gerenciar Clientes</h1>

    <!-- Alert feedback -->
    <div id="alertBox" class="alert d-none"></div>

    <!-- Lista de clientes -->
    <div class="search-item mb-4">
        <label>Buscar cliente</label><br>
        <input id="campoBusca" type="text" class="form-control" placeholder="Nome,CPF ou Email">
         <div class="card shadow-sm mt-2">
      <button class="btn btn-primary mt-2" onclick="buscarCliente()">Buscar</button>

    </div>
    </div>
    
        <div class="card-body">
            <h2 class="card-title">Clientes Registrados</h2>
            <table class="table table-striped mt-3">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>CPF</th>
                        <th>Nome</th>
                        <th>Email</th>
                        <th>A√ß√µes</th>
                    </tr>
                </thead>
                <tbody id="listaClientes"></tbody>
            </table>
        </div>
        <div class="card shadow-sm mb-4">
        <a href="{{ url_for('config') }}" class="btn btn-secondary">‚¨ÖÔ∏è Voltar para Configura√ß√µes</a>
    </div>
    </div>

    <!-- Bot√£o voltar -->
    
</div>

<script>
    function showAlert(message, type="success") {
        const alertBox = document.getElementById("alertBox");
        alertBox.className = `alert alert-${type}`;
        alertBox.textContent = message;
        alertBox.classList.remove("d-none");
        setTimeout(() => alertBox.classList.add("d-none"), 3000);
    }

    

    function listarClientes() {
        fetch("/api/clientes")
            .then(res => res.json())
            .then(clientes => {
                const tabela = document.getElementById("listaClientes");
                tabela.innerHTML = "";

                if (clientes.length === 0) {
                    tabela.innerHTML = `
                        <tr>
                            <td colspan="4" class="text-center text-muted">Nenhum cliente encontrado.</td>
                        </tr>
                    `;
                    return;
                }

                clientes.forEach(c => {
                    const linha = document.createElement("tr");
                    linha.innerHTML = `
                        <td>${c.id}</td>
                        <td>${c.cpf}</td>
                        <td>${c.nome}</td>
                        <td>${c.email}</td>
                        <td>
                            <button class="btn btn-danger btn-sm" onclick="removerCliente(event, ${c.id})">Excluir</button>
                        </td>
                    `;
                    tabela.appendChild(linha);
                });
            })
            .catch(err => {
                showAlert("Erro ao carregar clienteszzz.", "danger");
                console.error(err);
            });
    }

    function removerCliente(event, id) {
        if (!confirm("Tem certeza que deseja excluir este cliente?")) return;

        const btn = event.target;
        btn.disabled = true;
        btn.textContent = "Excluindo...";

        fetch(`/api/clientes/${id}`, { method: "DELETE" })
            .then(res => res.json())
            .then(data => {
                showAlert(data.mensagem || data.erro, data.erro ? "danger" : "success");
                listarClientes();
            })
            .catch(() => showAlert("Erro ao excluir cliente.", "danger"))
            .finally(() => {
                btn.disabled = false;
                btn.textContent = "Excluir";
            });
    }
    function buscarCliente() {
    const termo = document.getElementById("campoBusca").value.trim();

    //  Se o campo estiver vazio ‚Üí lista tudo
    if (!termo) {
        listarClientes();
        return;
    }

    //  Se tiver algo ‚Üí busca filtrada
    fetch(`/api/clientes/buscar?q=${encodeURIComponent(termo)}`)
        .then(res => res.json())
        .then(cliente => {
            const tabela = document.getElementById("listaClientes");
            tabela.innerHTML = "";

            //  Se n√£o encontrou nada
            if (!cliente || cliente.mensagem || cliente.erro) {
                tabela.innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center text-muted">Nenhum cliente encontrado.</td>
                    </tr>
                `;
                return;
            }

            //  Se encontrou ‚Üí mostra s√≥ ele
            const linha = document.createElement("tr");
            linha.innerHTML = `
                <td>${cliente.id}</td>
                <td>${cliente.cpf}</td>
                <td>${cliente.nome}</td>
                <td>${cliente.email}</td>
                <td>
                    <button class="btn btn-danger btn-sm" onclick="removerCliente(event, ${cliente.id})">Excluir</button>
                </td>
            `;
            tabela.appendChild(linha);
        })
        .catch(err => {
            showAlert("Erro ao buscar cliente.", "danger");
            console.error(err);
        });
}


    listarClientes();
</script>

{% endblock %}
