{% extends "base.html" %}

{% block title %}Início - Passagens Online{% endblock %}

{% block content %}
<!-- Hero Section -->
<header class="bg-white py-5 shadow-sm fade-in">
    <div class="container text-center">
        <h1 class="display-4 fw-bold text-primary mb-3">
            <i class="bi bi-airplane"></i> Encontre sua próxima viagem
        </h1>
        <p class="lead text-secondary">Compare preços e compre passagens aéreas com facilidade</p>
    </div>
</header>

<!-- Busca de Passagens -->
<section class="container my-5 fade-in">
    <div class="card card-custom p-4">
        <h3 class="text-center mb-4">
            <i class="bi bi-search"></i> Buscar Passagens
        </h3>
        <form id="formBusca" class="row g-3">
            <div class="col-md-4">
                <label for="origem" class="form-label fw-bold">
                    <i class="bi bi-geo-alt"></i> Origem
                </label>
                <input type="text" class="form-control form-control-custom" id="origem" placeholder="Ex: Salvador" required>
            </div>
            <div class="col-md-4">
                <label for="destino" class="form-label fw-bold">
                    <i class="bi bi-geo-alt-fill"></i> Destino
                </label>
                <input type="text" class="form-control form-control-custom" id="destino" placeholder="Ex: São Paulo" required>
            </div>
            <div class="col-md-4">
                <label for="data" class="form-label fw-bold">
                    <i class="bi bi-calendar-event"></i> Data da Viagem
                </label>
                <input type="date" class="form-control form-control-custom" id="data">
            </div>
            <div class="col-12 text-center mt-4">
                <button type="submit" class="btn btn-success btn-custom btn-lg px-5">
                    <i class="bi bi-search"></i> Buscar Passagens
                </button>
            </div>
        </form>
        
        <!-- Área de Resultados -->
        <div id="resultadosBusca" class="mt-4"></div>
    </div>
</section>

<!-- Destinos Populares -->
<section class="bg-white py-5 shadow-sm">
    <div class="container">
        <h2 class="text-center mb-5 fw-bold">
            <i class="bi bi-star-fill text-warning"></i> Destinos Populares
        </h2>
        <div class="row g-4">
            <!-- Rio de Janeiro -->
            <div class="col-md-4">
                <div class="card card-custom h-100 border-0">
                    <img src="{{ url_for('static', filename='IMG/rio.jpg') }}" 
                         class="card-img-top" 
                         alt="Rio de Janeiro"
                         style="height: 250px; object-fit: cover; border-radius: 10px 10px 0 0;">
                    <div class="card-body text-center">
                        <h5 class="card-title fw-bold text-primary">
                            <i class="bi bi-geo-alt-fill"></i> Rio de Janeiro
                        </h5>
                        <p class="card-text text-muted">Sol, praia e diversão garantida.</p>
                        <a href="{{ url_for('comprar_pass') }}" class="btn btn-outline-primary btn-custom mt-2">
                            Ver Ofertas
                        </a>
                    </div>
                </div>
            </div>
            
            <!-- São Paulo -->
            <div class="col-md-4">
                <div class="card card-custom h-100 border-0">
                    <img src="{{ url_for('static', filename='IMG/sao_paulo.jpg') }}" 
                         class="card-img-top" 
                         alt="São Paulo"
                         style="height: 250px; object-fit: cover; border-radius: 10px 10px 0 0;">
                    <div class="card-body text-center">
                        <h5 class="card-title fw-bold text-primary">
                            <i class="bi bi-geo-alt-fill"></i> São Paulo
                        </h5>
                        <p class="card-text text-muted">A capital dos negócios e da cultura urbana.</p>
                        <a href="{{ url_for('comprar_pass') }}" class="btn btn-outline-primary btn-custom mt-2">
                            Ver Ofertas
                        </a>
                    </div>
                </div>
            </div>
            
            <!-- Fortaleza -->
            <div class="col-md-4">
                <div class="card card-custom h-100 border-0">
                    <img src="{{ url_for('static', filename='IMG/fortal.jpg') }}" 
                         class="card-img-top" 
                         alt="Fortaleza"
                         style="height: 250px; object-fit: cover; border-radius: 10px 10px 0 0;">
                    <div class="card-body text-center">
                        <h5 class="card-title fw-bold text-primary">
                            <i class="bi bi-geo-alt-fill"></i> Fortaleza
                        </h5>
                        <p class="card-text text-muted">Belezas naturais e clima tropical.</p>
                        <a href="{{ url_for('comprar_pass') }}" class="btn btn-outline-primary btn-custom mt-2">
                            Ver Ofertas
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Seção de Vantagens -->
<section class="container my-5">
    <div class="row g-4 text-center">
        <div class="col-md-4">
            <div class="card card-custom border-0 h-100 p-4">
                <div class="card-body">
                    <i class="bi bi-shield-check text-success" style="font-size: 3rem;"></i>
                    <h5 class="mt-3 fw-bold">Compra Segura</h5>
                    <p class="text-muted">Suas informações protegidas em todas as transações</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card card-custom border-0 h-100 p-4">
                <div class="card-body">
                    <i class="bi bi-clock-history text-primary" style="font-size: 3rem;"></i>
                    <h5 class="mt-3 fw-bold">Atendimento 24h</h5>
                    <p class="text-muted">Suporte disponível a qualquer momento</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card card-custom border-0 h-100 p-4">
                <div class="card-body">
                    <i class="bi bi-tag text-warning" style="font-size: 3rem;"></i>
                    <h5 class="mt-3 fw-bold">Melhores Preços</h5>
                    <p class="text-muted">Encontre as melhores ofertas do mercado</p>
                </div>
            </div>
        </div>
    </div>
</section>

<script>
// Evento de submit do formulário
document.getElementById('formBusca').addEventListener('submit', function(e) {
    e.preventDefault();
    buscarVoos();
});

function buscarVoos() {
    const origem = document.getElementById('origem').value.trim();
    const destino = document.getElementById('destino').value.trim();
    const data = document.getElementById('data').value;
    
    if (!origem || !destino) {
        mostrarAlerta('Por favor, preencha origem e destino!', 'warning');
        return;
    }
    
    // Mostra loading
    const resultadosDiv = document.getElementById('resultadosBusca');
    resultadosDiv.innerHTML = `
        <div class="text-center py-4">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Carregando...</span>
            </div>
            <p class="mt-3 text-muted">Buscando voos disponíveis...</p>
        </div>
    `;
    
    // Faz a requisição para API
    let url = `/api/voos?origem=${encodeURIComponent(origem)}&destino=${encodeURIComponent(destino)}`;
    if (data) {
        url += `&data=${encodeURIComponent(data)}`;
    }
    
    fetch(url)
        .then(res => res.json())
        .then(voos => {
            if (voos.length === 0) {
                mostrarResultadoVazio();
            } else {
                exibirResultados(voos);
            }
        })
        .catch(err => {
            console.error('Erro:', err);
            mostrarErro();
        });
}

function exibirResultados(voos) {
    const resultadosDiv = document.getElementById('resultadosBusca');
    
    let html = `
        <div class="border-top pt-4 mt-4">
            <h5 class="text-primary mb-3">
                <i class="bi bi-check-circle"></i> ${voos.length} voo(s) encontrado(s)
            </h5>
            <div class="row g-3">
    `;
    
    voos.forEach(voo => {
        html += `
            <div class="col-md-6">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <div>
                                <h5 class="card-title mb-1">
                                    <i class="bi bi-arrow-right-circle text-primary"></i>
                                    ${voo.origem} → ${voo.destino}
                                </h5>
                                <small class="text-muted">Voo #${voo.id}</small>
                            </div>
                            <span class="badge bg-success fs-6">R$ ${parseFloat(voo.preco).toFixed(2)}</span>
                        </div>
                        
                        <div class="row g-2 mb-3">
                            <div class="col-6">
                                <small class="text-muted d-block">
                                    <i class="bi bi-calendar3"></i> Data
                                </small>
                                <strong>${voo.data || 'A definir'}</strong>
                            </div>
                            <div class="col-6">
                                <small class="text-muted d-block">
                                    <i class="bi bi-clock"></i> Horário
                                </small>
                                <strong>${voo.horario || 'A definir'}</strong>
                            </div>
                        </div>
                        
                        <div class="row g-2 mb-3">
                            <div class="col-6">
                                <small class="text-muted d-block">
                                    <i class="bi bi-airplane"></i> Aeronave
                                </small>
                                <strong>${voo.t_aeronave || 'N/A'}</strong>
                            </div>
                            <div class="col-6">
                                <small class="text-muted d-block">
                                    <i class="bi bi-people"></i> Assentos
                                </small>
                                <strong>${voo.n_assentos || 'N/A'} disponíveis</strong>
                            </div>
                        </div>
                        
                        <div class="d-flex gap-2 mt-3">
                            <button class="btn btn-primary btn-sm flex-grow-1" onclick="comprarVoo(${voo.id})">
                                <i class="bi bi-cart-plus"></i> Comprar
                            </button>
                            <button class="btn btn-outline-primary btn-sm" onclick="verDetalhes(${voo.id})">
                                <i class="bi bi-info-circle"></i> Detalhes
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    html += `
            </div>
            <div class="text-center mt-4">
                <a href="{{ url_for('comprar_pass') }}" class="btn btn-outline-primary btn-custom">
                    <i class="bi bi-search"></i> Ver Busca Avançada
                </a>
            </div>
        </div>
    `;
    
    resultadosDiv.innerHTML = html;
    
    // Scroll suave até os resultados
    resultadosDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

function mostrarResultadoVazio() {
    const resultadosDiv = document.getElementById('resultadosBusca');
    resultadosDiv.innerHTML = `
        <div class="alert alert-info border-0 shadow-sm mt-4">
            <div class="text-center py-3">
                <i class="bi bi-info-circle" style="font-size: 3rem;"></i>
                <h5 class="mt-3">Nenhum voo encontrado</h5>
                <p class="mb-3">Não encontramos voos diretos para essa rota.</p>
                <a href="{{ url_for('comprar_pass') }}" class="btn btn-primary btn-custom">
                    <i class="bi bi-shuffle"></i> Buscar voos com conexão
                </a>
            </div>
        </div>
    `;
}

function mostrarErro() {
    const resultadosDiv = document.getElementById('resultadosBusca');
    resultadosDiv.innerHTML = `
        <div class="alert alert-danger border-0 shadow-sm mt-4">
            <div class="text-center py-3">
                <i class="bi bi-x-circle" style="font-size: 3rem;"></i>
                <h5 class="mt-3">Erro ao buscar voos</h5>
                <p class="mb-0">Ocorreu um erro ao buscar as passagens. Tente novamente.</p>
            </div>
        </div>
    `;
}

function mostrarAlerta(mensagem, tipo) {
    const resultadosDiv = document.getElementById('resultadosBusca');
    resultadosDiv.innerHTML = `
        <div class="alert alert-${tipo} alert-dismissible fade show mt-4" role="alert">
            <i class="bi bi-exclamation-triangle"></i> ${mensagem}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
}

function comprarVoo(vooId) {
    // Verifica se o usuário está logado
    fetch('/api/usuario-logado')
        .then(res => res.json())
        .then(usuario => {
            if (!usuario || !usuario.id) {
                if (confirm('Você precisa fazer login para comprar passagens. Deseja fazer login agora?')) {
                    window.location.href = '/login';
                }
                return;
            }
            
            // Realiza a compra
            return fetch("/api/comprar", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    usuario_id: usuario.id,
                    voo_id: vooId
                })
            });
        })
        .then(res => {
            if (res) return res.json();
        })
        .then(data => {
            if (data) {
                alert(data.mensagem || "Compra realizada com sucesso!");
                window.location.href = '/voos/';
            }
        })
        .catch(err => {
            alert("Erro ao comprar passagem. Tente novamente.");
            console.error(err);
        });
}

function verDetalhes(vooId) {
    // Redireciona para a página de compra com o ID do voo
    window.location.href = `{{ url_for('comprar_pass') }}?voo_id=${vooId}`;
}
</script>
{% endblock %}